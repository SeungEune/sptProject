<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <link rel="stylesheet" th:href="@{/css/lunch/register.css}">
</head>

<body>

<div th:replace="~{cmm/layout/mainLayout :: layout (~{::content})}">

    <div th:fragment="content">
        <h1 class="content-title">점심/커피 내역 삭제</h1>

        <div class="content-body lunch-layout">

            <form class="entry-form readonly-form"
                  th:action="@{/lunch/delete.do}" method="post">

                <input type="hidden" name="lunchId" th:value="${lunch.lunchId}">

                <div class="form-group">
                    <label for="date-input">날짜</label>
                    <input type="date" id="date-input" th:value="${lunch.date}" disabled>
                </div>

                <div class="form-group">
                    <label for="store-name">가게명</label>
                    <input type="text" id="store-name" th:value="${lunch.storeName}" disabled>
                </div>

                <div class="form-group">
                    <label>참석자</label>
                    <input type="text" id="participant-summary" disabled style="color: #6b7280;">
                </div>

                <div class="form-group">
                    <label for="payer-name">계산자</label>
                    <input type="text" id="payer-name" th:value="${lunch.payerName}" disabled>
                </div>

                <fieldset class="form-group">
                    <legend class="legend-title">유형</legend>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="type-lunch" value="점심"
                                   th:checked="${lunch.type == '점심'}" disabled>
                            <label for="type-lunch">점심</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="type-coffee" value="커피"
                                   th:checked="${lunch.type == '커피'}" disabled>
                            <label for="type-coffee">커피</label>
                        </div>
                    </div>
                </fieldset>

                <button type="button"
                        class="submit-btn btn-red" onclick="confirmDelete()">삭제
                </button>

            </form>

            <div class="amount-panel">
                <h2 class="amount-panel-title">개인별 금액</h2>

                <div class="amount-list" id="amount-list-container">
                    <p id="amount-placeholder" class="amount-placeholder">
                        참석자 정보를 불러오는 중...
                    </p>
                </div>
            </div>

        </div>
    </div>
</div>

<script th:inline="javascript">
    const userList = /*[[${userList}]]*/ [];
    const existingParticipants = /*[[${lunch.participants}]]*/ '';

    function confirmDelete() {
        Swal.fire({
            title: '점심/커피 내역 삭제',
            text: '이 점심/커피 내역을 삭제하시겠습니까?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '삭제',
            cancelButtonText: '취소',
            allowOutsideClick: false,
            // 스타일 지정
            buttonsStyling: false,
            customClass: {
                confirmButton: 'btn-red',
                cancelButton: 'btn-gray'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                document.querySelector('.entry-form').submit();
            }
        });
    }

    window.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('amount-list-container');
        const placeholder = document.getElementById('amount-placeholder');
        const summaryInput = document.getElementById('participant-summary');

        if (existingParticipants) {
            placeholder.style.display = 'none';

            // 콤마로 분리
            const list = existingParticipants.split(',');
            const names = []; // 이름 모으기용 배열

            list.forEach(item => {
                const parts = item.split(':');
                if (parts.length !== 2) return;

                // 공백 제거 (trim)
                const userId = parts[0].trim();
                const amount = parts[1].trim();

                const user = userList.find(u => u.userId === userId);
                if (!user) return;

                names.push(user.userName); // 이름 저장

                // UI 생성
                const row = document.createElement('div');
                row.className = 'amount-row';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'name';
                nameSpan.textContent = user.userName;

                const group = document.createElement('div');
                group.className = 'amount-input-group';

                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.value = amount;
                amountInput.disabled = true;
                amountInput.style.backgroundColor = '#f3f4f6';
                amountInput.style.cursor = 'not-allowed';
                amountInput.style.color = '#374151';

                const unitSpan = document.createElement('span');
                unitSpan.textContent = '원';

                group.appendChild(amountInput);
                group.appendChild(unitSpan);

                row.appendChild(nameSpan);
                row.appendChild(group);

                container.appendChild(row);
            });

            // 왼쪽 참석자 입력칸에 요약 정보 표시
            if (names.length > 0) {
                if (names.length <= 2) {
                    summaryInput.value = names.join(', ');
                } else {
                    summaryInput.value = `${names[0]}, ${names[1]} 외 ${names.length - 2}명`;
                }
            }
        } else {
            placeholder.textContent = "참석자가 없습니다.";
            summaryInput.value = "없음";
        }
    });
</script>

</body>
</html>
