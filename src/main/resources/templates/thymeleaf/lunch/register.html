<!DOCTYPE html>
<html th:replace="~{cmm/layout/mainLayout :: layout (~{::content})}"
      xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>점심/커피 내역 등록</title>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/lunch/register.css}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<!-- 모바일 햄버거 버튼 -->
<button id="menu-toggle" class="mobile-menu-toggle">
    <i class="fas fa-bars"></i>
</button>
<div id="overlay" class="mobile-overlay"></div>
    <div th:fragment="content">
        <h1 class="content-title">점심/커피 내역 등록</h1>

        <div class="content-body lunch-layout">

                <form class="entry-form"
                      th:action="@{/lunch/register.do}"
                      method="post">

                    <!-- 날짜 -->
                    <div class="form-group">
                        <label for="date-input">날짜</label>
                        <input type="date" id="date-input" name="date"
                               th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required>
                    </div>

                    <!-- 가게명 -->
                    <div class="form-group">
                        <label for="store-name">가게명</label>
                        <input type="text" id="store-name" name="storeName" placeholder="내용을 입력하세요" required>
                    </div>

                    <!-- 참석자 검색 -->
                    <div class="form-group">
                        <label for="participant-search">참석자 선택
                            <span class="label-description">이름을 검색하여 클릭하면 금액 입력란이 생성됩니다</span>
                        </label>
                        <input type="text" id="participant-search"
                               onkeydown="if(event.key === 'Enter') event.preventDefault();"
                               onkeyup="filterParticipants()"
                               placeholder="내용을 입력하세요">
                        <div id="search-results" class="search-results-dropdown" style="display: none;"></div>
                    </div>

                    <!-- 계산자 검색 -->
                    <div class="form-group">
                        <label for="payer-search">계산자 선택
                            <span class="label-description">계산한 사람의 이름을 검색하여 선택하세요.</span>
                        </label>
                        <input type="text" id="payer-search"
                               onkeydown="if(event.key === 'Enter') event.preventDefault();"
                               onkeyup="filterPayers()"
                               placeholder="내용을 입력하세요">
                        <input type="hidden" id="payerId" name="payerId" required>
                        <div id="payer-results" class="search-results-dropdown" style="display: none;"></div>
                    </div>

                    <!-- 유형 선택 -->
                    <fieldset class="form-group">
                        <legend class="legend-title">유형 선택</legend>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="type-lunch" name="type" value="점심" checked>
                                <label for="type-lunch">점심</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="type-coffee" name="type" value="커피">
                                <label for="type-coffee">커피</label>
                            </div>
                        </div>
                    </fieldset>

                    <!-- hidden fields -->
                    <div id="hidden-fields"></div>

                    <button type="button" class="submit-btn" onclick="confirmAdd()">등록</button>
                </form>

                <!-- 오른쪽 금액 입력 패널 -->
                <div class="amount-panel">
                    <h2 class="amount-panel-title">개인별 금액 입력</h2>

                    <div class="amount-list" id="amount-list-container">
                        <p id="amount-placeholder" class="amount-placeholder" style="display: block;">
                            참석자를 선택하면 여기에 입력칸이 생성됩니다.
                        </p>
                    </div>
                </div>
        </div>
    </div>

<script th:inline="javascript">
    // --- 유저 데이터 로드 ---
    const userList = /*[[${userList}]]*/ [];
    console.log("userList:", userList);
    console.log("userList 길이:", userList.length);
    const selectedParticipants = new Set();
    let selectedPayerId = null;

    // --- 참석자 검색 및 선택 로직 ---
    function filterParticipants() {
        const query = document.getElementById('participant-search').value.toLowerCase().trim();
        const resultsDiv = document.getElementById('search-results');

        if (query === '') {
            resultsDiv.style.display = 'none';
            resultsDiv.innerHTML = '';
            return;
        }

        const filtered = userList.filter(user =>
            user.userName.toLowerCase().includes(query) && !selectedParticipants.has(user.userId)
        );

        if (filtered.length === 0) {
            resultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">검색 결과가 없습니다.</div>';
            resultsDiv.style.display = 'block';
            return;
        }

        resultsDiv.innerHTML = filtered.map(user =>
            `<div onclick="addParticipant('${user.userId}', '${user.userName}')">
                ${user.userName}
            </div>`
        ).join('');

        resultsDiv.style.display = 'block';
    }

    // --- addParticipant ---
    function addParticipant(userId, userName) {
        if (selectedParticipants.has(userId)) return;

        selectedParticipants.add(userId);

        const container = document.getElementById('amount-list-container');
        const placeholder = document.getElementById('amount-placeholder');
        placeholder.style.display = 'none';

        // --- 새 HTML 구조(.amount-row)에 맞게 요소 생성 ---
        const amountRow = document.createElement('div');
        amountRow.className = 'amount-row';
        amountRow.id = 'participant-row-' + userId;

        // 1. 이름
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.innerText = userName;

        // 2. 금액 입력 그룹
        const amountGroup = document.createElement('div');
        amountGroup.className = 'amount-input-group';

        const uiAmountInput = document.createElement('input');
        uiAmountInput.type = 'number';
        uiAmountInput.placeholder = '금액입력';
        uiAmountInput.required = true;

        const unitSpan = document.createElement('span');
        unitSpan.innerText = '원';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = () => removeParticipant(userId);

        amountGroup.appendChild(uiAmountInput);
        amountGroup.appendChild(unitSpan);
        amountGroup.appendChild(removeBtn);

        amountRow.appendChild(nameSpan);
        amountRow.appendChild(amountGroup);

        container.appendChild(amountRow);

        const hiddenFields = document.getElementById("hidden-fields");

        const hiddenUserInput = document.createElement("input");
        hiddenUserInput.type = "hidden";
        hiddenUserInput.name = "participantUserIds";
        hiddenUserInput.value = userId;
        hiddenUserInput.id = "hidden-user-" + userId;

        const hiddenAmountInput = document.createElement("input");
        hiddenAmountInput.type = "hidden";
        hiddenAmountInput.name = "participantAmounts";
        hiddenAmountInput.value = "0";
        hiddenAmountInput.id = "hidden-amount-" + userId;

        uiAmountInput.addEventListener("input", () => {
            hiddenAmountInput.value = uiAmountInput.value;
        });

        hiddenFields.appendChild(hiddenUserInput);
        hiddenFields.appendChild(hiddenAmountInput);

        document.getElementById('participant-search').value = '';
        document.getElementById('search-results').style.display = 'none';
    }


    // --- removeParticipant ---
    function removeParticipant(userId) {
        selectedParticipants.delete(userId);

        const rowToRemove = document.getElementById('participant-row-' + userId);
        if (rowToRemove) rowToRemove.remove();

        const hiddenUser = document.getElementById('hidden-user-' + userId);
        const hiddenAmount = document.getElementById('hidden-amount-' + userId);
        if (hiddenUser) hiddenUser.remove();
        if (hiddenAmount) hiddenAmount.remove();

        const container = document.getElementById('amount-list-container');
        const placeholder = document.getElementById('amount-placeholder');

        if (container.children.length === 1) {
            placeholder.style.display = 'block';
        }
    }

    // --- 계산자 검색 ---
    function filterPayers() {
        const query = document.getElementById('payer-search').value.toLowerCase().trim();
        const resultsDiv = document.getElementById('payer-results');

        if (query === '') {
            resultsDiv.style.display = 'none';
            resultsDiv.innerHTML = '';
            return;
        }

        const filtered = userList.filter(user =>
            user.userName.toLowerCase().includes(query)
        );

        if (filtered.length === 0) {
            resultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">검색 결과가 없습니다.</div>';
            resultsDiv.style.display = 'block';
            return;
        }

        resultsDiv.innerHTML = filtered.map(user =>
            `<div onclick="selectPayer('${user.userId}', '${user.userName}')">
                ${user.userName}
            </div>`
        ).join('');

        resultsDiv.style.display = 'block';
    }

    // --- 계산자 선택 ---
    function selectPayer(userId, userName) {
        selectedPayerId = userId;
        document.getElementById('payerId').value = userId;
        document.getElementById('payer-search').value = userName;
        document.getElementById('payer-results').style.display = 'none';
    }

    // 확인 모달
    function confirmAdd() {
        // 1. 유효성 검사 (빈칸 체크)
        const form = document.querySelector('.entry-form');
        if (!form.checkValidity()) {
            form.reportValidity(); // "이 입력란을 작성하세요" 말풍선 띄움
            return; // 함수 종료 (모달 안 띄움)
        }
        Swal.fire({
            title: '내역 등록',
            text: "현재 내용으로 새로 등록하시겠습니까?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '등록',
            cancelButtonText: '취소',

            //스타일 지정
            buttonsStyling: false,
            customClass: {
                confirmButton: 'btn-blue',
                cancelButton: 'btn-gray'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                 document.querySelector('.entry-form').submit();
            }
        });
    }

    // --- 사이드바 토글 ---
    const menuToggle = document.getElementById('menu-toggle');
    const closeMenu = document.getElementById('close-menu');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');

    if (menuToggle) {
        function openSidebar() {
            if (sidebar) sidebar.classList.add('active');
            if (overlay) overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebarFunc() {
            if (sidebar) sidebar.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        menuToggle.addEventListener('click', openSidebar);
        if (closeMenu) closeMenu.addEventListener('click', closeSidebarFunc);
        if (overlay) overlay.addEventListener('click', closeSidebarFunc);
    }

    // --- 드롭다운 자동 숨김 처리 ---
    document.addEventListener('click', function(event) {
        const participantSearchContainer = document.getElementById('participant-search').closest('.form-group');
        const payerSearchContainer = document.getElementById('payer-search').closest('.form-group');

        if (!participantSearchContainer.contains(event.target)) {
            document.getElementById('search-results').style.display = 'none';
        }
        if (!payerSearchContainer.contains(event.target)) {
            document.getElementById('payer-results').style.display = 'none';
        }
    });

</script>

</body>
</html>
