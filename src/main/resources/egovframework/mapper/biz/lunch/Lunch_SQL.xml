<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="biz.lunch.dao.LunchMapper">

    <!-- 점심/커피 내역 등록 (ServiceImpl에서 참여자 별도 등록) -->
    <insert id="registerLunch" parameterType="map"
            useGeneratedKeys="true" keyProperty="lunchId" keyColumn="lunch_id">
        INSERT INTO lunch_master (
            date, store_name, payer_id, total_amount, type, created_at
        ) VALUES (
                     #{date}, #{storeName}, #{payerId}, #{totalAmount}, #{type}, NOW()
                 )
    </insert>

    <!-- 점심/커피 내역 수정 -->
    <update id="updateLunch" parameterType="map">
        UPDATE lunch_master
        SET store_name = #{storeName},
            payer_id = #{payerId},
            date = #{date},
            total_amount = #{totalAmount},
            type = #{type}
        WHERE lunch_id = #{lunchId};
    </update>

    <!-- 기존 참여자 전체 삭제 -->
    <delete id="deleteParticipantsByLunchId" parameterType="int">
        DELETE FROM lunch_participant
        WHERE lunch_id = #{lunchId};
    </delete>

    <!-- 새로운 참여자 등록 (일괄 등록 처리) -->
    <insert id="insertParticipantsBatch" parameterType="map">
        INSERT INTO lunch_participant (
        lunch_id, user_id, individual_amount, is_paid
        ) VALUES
        <foreach collection="participants" item="p" separator=",">
            (#{lunchId}, #{p.userId}, #{p.individualAmount}, 'N')
        </foreach>
    </insert>

    <!-- 점심/커피 내역 삭제 (CASCADE에 의해 참여자 자동 삭제됨) -->
    <delete id="deleteLunch" parameterType="int">
        DELETE FROM lunch_master
        WHERE lunch_id = #{lunchId};
    </delete>

    <!-- 점심/커피 내역 조회 -->
    <select id="getLunchList" parameterType="map" resultType="map">
        SELECT
        m.lunch_id,
        m.date,
        m.store_name,
        m.total_amount,
        m.type,
        m.payer_id,
        u.user_nm AS payer_name,
        STRING_AGG(p.user_id || ':' || p.individual_amount, ', ') AS participants,
        SUM(p.individual_amount) AS total_participant_amount
        FROM lunch_master m
        JOIN tb_user u ON m.payer_id = u.user_id
        LEFT JOIN lunch_participant p ON m.lunch_id = p.lunch_id
        WHERE 1=1
        <if test="type != null and type != ''">
            AND m.type = #{type}
        </if>
        <if test="startDate != null">
            AND m.date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND m.date &lt;= #{endDate}
        </if>
        GROUP BY m.lunch_id, m.date, m.store_name, m.total_amount, m.type, m.payer_id, u.user_nm
        ORDER BY m.date DESC;
    </select>

    <!-- 사용자별/월별 통계 조회 -->
    <select id="getStatistics" parameterType="map" resultType="map">
        SELECT
        s.user_id,
        u.user_nm,
        s.month,
        s.total_paid,
        s.total_owed,
        s.balance,
        u2.user_nm AS representative_payer
        FROM lunch_summary s
        JOIN tb_user u ON s.user_id = u.user_id
        LEFT JOIN tb_user u2 ON s.representative_payer_id = u2.user_id
        <where>
            <if test="month != null">
                s.month = #{month}
            </if>
        </where>
        ORDER BY s.balance DESC;
    </select>

    <!-- 월별 정산 완료 처리 (DB에 status, paid_at 존재 시 작동) -->
    <update id="completeSettlement" parameterType="map">
        UPDATE lunch_summary
        SET status = 'PAID',
            paid_at = NOW()
        WHERE month = #{month}
          AND user_id = #{userId};
    </update>

</mapper>
