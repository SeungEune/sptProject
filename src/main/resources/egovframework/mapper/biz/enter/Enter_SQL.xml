<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="EnterDAO">
    <select id="selectEnterList" resultType="biz.enter.vo.EnterVO">
        SELECT
            e.enter_id     AS enterId,
            e.user_id      AS userId,
            u.user_nm      AS name,
            u.moblphon_no  AS phone,
            u.email_adres  AS email,
            u.jssfc_cd     AS jssfcCd,
            e.guest_nm     AS guestNm,
            e.guest_phone  AS guestPhone,
            e.guest_email  AS guestEmail,
            e.method_cd    AS method,
            e.status_cd    AS status,
            e.type_cd      AS type,
            e.regist_dt    AS registDt,
            e.start_guest_dt AS startGuestDt,
            e.end_guest_dt AS endGuestDt
        FROM tb_enter e
                 LEFT JOIN tb_user u ON e.user_id = u.user_id
        ORDER BY e.enter_id DESC
            LIMIT #{size} OFFSET #{offset}
    </select>


    <select id="selectEnterCount" resultType="int">
        SELECT COUNT(*) FROM tb_enter
    </select>


    <insert id="insertEnter" parameterType="biz.enter.vo.EnterVO">
        INSERT INTO tb_enter (
        enter_id,
        method_cd,
        status_cd,
        type_cd,
        start_guest_dt,
        end_guest_dt,
        regist_dt
        <if test="type == 'EMP'">
            , user_id
        </if>
        <if test="type == 'GUEST'">
            , guest_nm, guest_phone, guest_email
        </if>
        )
        VALUES (
        #{enterId},
        #{method},
        #{status},
        #{type},
        #{startGuestDt, jdbcType=DATE},
        #{endGuestDt, jdbcType=DATE},
        NOW()
        <if test="type == 'EMP'">
            , #{userId}
        </if>
        <if test="type == 'GUEST'">
            , #{guestNm}, #{guestPhone}, #{guestEmail}
        </if>
        )
    </insert>

    <!-- 단건 조회 -->
    <select id="selectEnter" resultType="biz.enter.vo.EnterVO">
        SELECT
            e.enter_id     AS enterId,
            e.user_id      AS userId,
            u.user_nm      AS name,
            u.moblphon_no  AS phone,
            u.email_adres  AS email,
            u.jssfc_cd     AS jssfcCd,
            e.guest_nm     AS guestNm,
            e.guest_phone  AS guestPhone,
            e.guest_email  AS guestEmail,
            e.method_cd    AS method,
            e.status_cd    AS status,
            e.type_cd      AS type,
            e.regist_dt    AS registDt,
            e.start_guest_dt AS startGuestDt,
            e.end_guest_dt AS endGuestDt
        FROM tb_enter e
                 LEFT JOIN tb_user u ON e.user_id = u.user_id
        WHERE e.enter_id = #{enterId}
    </select>

    <!-- 수정 -->
    <update id="updateEnter" parameterType="biz.enter.vo.EnterVO">
        UPDATE tb_enter
        SET
        <!-- userId 가 있을 때만 바꾸고, 없으면 건너뜀 -->
        <if test="userId != null and userId != ''">
            user_id = #{userId},
        </if>
        guest_nm     = #{guestNm},
        guest_phone  = #{guestPhone},
        guest_email  = #{guestEmail},
        method_cd    = #{method},
        status_cd    = #{status},
        type_cd      = #{type}
        <if test="startGuestDt != null">
         , start_guest_dt = #{startGuestDt, jdbcType=DATE}
        </if>
        <if test="endGuestDt != null">
         , end_guest_dt = #{endGuestDt, jdbcType=DATE}
        </if>
        WHERE enter_id = #{enterId}
    </update>


    <delete id="deleteEnter" parameterType="String">
        DELETE FROM tb_enter
        WHERE enter_id = #{enterId}
    </delete>

</mapper>